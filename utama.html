<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Litinova | Toko Buku Digital</title>

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600&family=Inter:wght@400;500&display=swap" rel="stylesheet">

  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  
  <!-- AOS CSS -->
  <link rel="stylesheet" href="https://unpkg.com/aos@next/dist/aos.css" />
  
  <!-- Google Translate -->
  <script type="text/javascript">
    function googleTranslateElementInit() {
      new google.translate.TranslateElement({
        pageLanguage: 'id',
        includedLanguages: 'en,id,zh,ja,ko,ar,es,fr,de,ru,pt,hi,th,vi',
        layout: google.translate.TranslateElement.InlineLayout.SIMPLE,
        autoDisplay: false
      }, 'google_translate_element');
    }
  </script>
  <script type="text/javascript" src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>

  <style>
body {
  font-family: 'Inter', sans-serif;
  background: linear-gradient(-45deg, 
    #f8fafc,  /* Soft white */
    #f1f5f9,  /* Light slate */
    #fef7ff,  /* Soft purple */
    #f0f9ff   /* Soft blue */
  );
  background-size: 400% 400%;
  background-position: 0% 50%;
  animation: gradientFlow 15s ease infinite;
  line-height: 1.6;
  padding-top: 72px; /* offset for fixed navbar */
}

    .navbar {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      padding: 12px 0;
      background-color: #ffffff;
      transition: all 0.3s ease;
      z-index: 1050;
      border-radius: 0;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
    }

    .navbar-brand img {
      height: 40px;
      margin-right: 10px;
      border-radius: 8px;
    }

    .navbar-nav .nav-link {
      margin-left: 20px;
      font-weight: 500;
      color: #374151 !important;
    }

    

    .btn-outline-primary {
      border-radius: 30px;
      padding: 10px 30px;
    }

    

    @keyframes gradientFlow {
      0% {
        background-position: 0% 50%;
      }
      50% {
        background-position: 100% 50%;
      }
      100% {
        background-position: 0% 50%;
      }
    }

    

    /* Section Heading */
    h2 {
      font-size: 2.5rem;
      font-weight: bold;
      color: hsl(214, 100%, 35%);
      margin-bottom: 1.5rem;
    }

    .btn-outline-primary {
      background-color: transparent;
      border-color: hsl(214, 100%, 66%);
      color: hsl(214, 100%, 40%);
      border-width: 2px;
      font-size: 0.9rem;
      padding: 0.6rem 1.2rem;
    }

    .btn-outline-primary:hover {
      background-color: hsl(214, 100%, 66%);
      color: white;
    }

    /* Horizontal list helpers (no scroll, wrap and center) */
    .h-scroll { 
      display: flex; 
      gap: 1rem; 
      flex-wrap: wrap; 
      justify-content: center;
      align-items: stretch;
      width: 100%;
      overflow: visible;
    }
    .h-item { 
      flex: 0 1 280px; 
      max-width: 320px;
      min-width: 250px;
      width: auto !important;
    }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    .team-photo {
        width: 100px;
        height: 100px;
        object-fit: cover;
        border-radius: 50%;
        margin-bottom: 1rem;
    }
    .team-icon {
        width: 50px;
        height: 50px;
    }
    * {
      transition: all 0.3s ease-in-out;
    }

    html, body { 
      max-width: 100%; 
      overflow-x: hidden;
      overflow-y: auto; 
      margin: 0;
      padding: 0;
    }

    /* Hide scrollbar but keep functionality */
    html::-webkit-scrollbar {
      width: 0px;
      background: transparent;
    }

    body {
      scrollbar-width: none;
      -ms-overflow-style: none;
    }

    /* Prevent any overflow and ensure proper centering */
    * {
      box-sizing: border-box;
    }

    section, .container, .row {
      overflow: visible;
      width: 100%;
    }

    /* Media should not exceed container width */
    img, video, iframe { 
      max-width: 100%; 
      height: auto; 
      display: block; 
    }

    /* Perpustakaan (Gutenberg) */
    #Perpustakaan {
      background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
      padding: 80px 20px;
      position: relative;
    }

    #Perpustakaan::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: radial-gradient(circle at 20% 80%, rgba(99, 102, 241, 0.05) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(168, 85, 247, 0.05) 0%, transparent 50%);
      pointer-events: none;
    }
    .library-toolbar {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      justify-content: center;
      margin-bottom: 24px;
    }
    .library-toolbar .form-control {
      max-width: 520px;
      height: 48px;
    }
    .library-toolbar .btn {
      height: 48px;
    }
    .library-results .card {
      border: 0;
      border-radius: 14px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.08);
      overflow: hidden;
    }
    .library-results .card-img-top {
      aspect-ratio: 2 / 3;
      width: 100%;
      height: auto;
      object-fit: contain;
      background: #f8f9fa;
    }
    .library-empty, .library-error {
      text-align: center;
      color: #6b7280;
    }
    .spinner {
      width: 28px; height: 28px; border: 3px solid #e5e7eb; border-top-color: #3b82f6; border-radius: 50%;
      animation: spin 1s linear infinite; display: inline-block;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Reader Modal - Redesigned */
    .reader-backdrop {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
      background: rgba(0,0,0,0.7); display: none; z-index: 1050;
    }
    .reader-modal {
      position: fixed; top: 3%; left: 3%; right: 3%; bottom: 3%;
      background: #fff; border-radius: 12px; display: none; z-index: 1060;
      box-shadow: 0 25px 50px rgba(0,0,0,0.3); 
      display: flex; flex-direction: column;
    }
    .reader-header {
      display: flex; align-items: center; justify-content: space-between; 
      padding: 16px 20px; background: #f8fafc; border-bottom: 1px solid #e5e7eb;
      flex-shrink: 0;
    }
    .reader-title {
      font-weight: 600; color: #111827; font-size: 1.1rem; margin: 0;
      overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
    }
    .reader-actions { display: flex; gap: 8px; }
    .reader-body {
      flex: 1; background: #ffffff; padding: 0;
      display: flex; flex-direction: column; overflow: hidden;
    }
    .reader-content {
      flex: 1; padding: 20px; overflow: auto;
      font-family: 'Georgia', serif; line-height: 1.7; font-size: 16px;
      white-space: pre-wrap; word-wrap: break-word;
    }
    .epub-container { 
      flex: 1; background: #ffffff; display: none;
    }
    .reader-loading {
      flex: 1; display: flex; align-items: center; justify-content: center;
      flex-direction: column; gap: 16px; color: #6b7280;
    }
    .reader-dark .reader-body { background: #1f2937; }
    .reader-dark .reader-content { background: #1f2937; color: #e5e7eb; }
    .reader-dark .reader-header { background: #374151; color: #e5e7eb; border-color: #4b5563; }

    /* Detail Modal */
    .info-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: none; z-index: 1050; }
    .info-modal { position: fixed; inset: 8% 10%; background: #fff; border-radius: 16px; display: none; z-index: 1060; box-shadow: 0 20px 60px rgba(0,0,0,0.25); overflow: hidden; }
    .info-header { display: flex; align-items: center; justify-content: space-between; padding: 10px 14px; background: #f8fafc; border-bottom: 1px solid #e5e7eb; }
    .info-title { font-weight: 600; color: #111827; font-size: 1rem; margin: 0; padding: 0 6px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .info-body { padding: 16px; max-height: calc(100vh - 220px); overflow: auto; }

    @media (max-width: 768px) {
      .reader-modal { inset: 4% 2%; }
      .info-modal { inset: 6% 3%; }
    }
    /* Hide legacy sections we no longer use */
    #Katalog, #katalog, #fitur, #carousel, #testimoni, #About, #Kontak { display: none !important; }
  </style>
</head>
<body>
<!-- Navbar -->
<nav id="beranda" class="navbar navbar-expand-lg navbar-light bg-white sticky-top">
  <div class="container">
    <a class="navbar-brand d-flex align-items-center" href="#">
      <img src="img/Logo2.png" alt="Litinova Logo">
      <span class="fw-bold fs-5">Litinova</span>
    </a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navMenu">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navMenu">
      <ul class="navbar-nav ms-auto">
        <li class="nav-item"><a class="nav-link" href="#Perpustakaan">Perpustakaan</a></li>
        <li class="nav-item">
          <div id="google_translate_element" style="margin-top: 8px;"></div>
        </li>
      </ul>
    </div>
  </div>

  <!-- Detail Modal -->
  <div id="infoBackdrop" class="info-backdrop"></div>
  <div id="infoModal" class="info-modal" role="dialog" aria-modal="true" aria-labelledby="infoTitle">
    <div class="info-header">
      <h5 id="infoTitle" class="info-title">Detail Buku</h5>
      <div class="reader-actions">
        <button id="closeInfo" class="btn btn-danger btn-sm" title="Tutup"><i class="bi bi-x-lg"></i></button>
      </div>
    </div>
    <div id="infoBody" class="info-body">
      <div class="d-flex justify-content-center align-items-center gap-2 text-muted"><span class="spinner"></span><span>Memuat detail…</span></div>
    </div>
  </div>
</nav>

<!-- Hero section removed -->

<!-- Beranda -->
<!-- Fitur section removed -->
<!-- Carousel section removed -->

<!-- Testimoni section removed -->

<!-- Katalog section removed -->

<!-- Perpustakaan (Gutenberg) -->
<section id="Perpustakaan">
  <div class="container">
    <div class="text-center mb-3" data-aos="fade-up">
      <h2 class="mb-2">Perpustakaan Publik</h2>
      <p class="text-muted">Cari dan baca e-book domain publik dari Project Gutenberg.</p>
    </div>

    <div class="library-toolbar" data-aos="fade-up" data-aos-delay="100">
      <input id="searchInput" type="text" class="form-control" placeholder="Cari judul/penulis (contoh: Sherlock Holmes)">
      <button id="searchBtn" class="btn btn-primary"><i class="bi bi-search me-1"></i>Cari</button>
      <button id="clearBtn" class="btn btn-outline-secondary"><i class="bi bi-x-circle me-1"></i>Bersihkan</button>
    </div>

    <div id="libraryStatus" class="text-center mb-3" style="min-height:36px;" aria-live="polite"></div>

    <div id="results" class="library-results row g-4 justify-content-center" data-aos="fade-up" data-aos-delay="150"></div>
  </div>

  <!-- Reader Modal - Redesigned -->
  <div id="readerBackdrop" class="reader-backdrop"></div>
  <div id="readerModal" class="reader-modal" role="dialog" aria-modal="true" aria-labelledby="readerTitle">
    <div class="reader-header">
      <h5 id="readerTitle" class="reader-title">Membaca…</h5>
      <div class="reader-actions">
        <button id="fontMinus" class="btn btn-outline-secondary btn-sm" title="Kecilkan teks">A-</button>
        <button id="fontPlus" class="btn btn-outline-secondary btn-sm" title="Besarkan teks">A+</button>
        <button id="toggleTheme" class="btn btn-outline-secondary btn-sm" title="Mode gelap"><i class="bi bi-moon"></i></button>
        <button id="translateToggle" class="btn btn-outline-primary btn-sm" title="Terjemahkan ke Indonesia">Terjemahkan (ID)</button>
        <button id="closeReader" class="btn btn-danger btn-sm" title="Tutup"><i class="bi bi-x-lg"></i></button>
      </div>
    </div>
    <div class="reader-body">
      <div id="readerLoading" class="reader-loading">
        <div class="spinner"></div>
        <span>Memuat konten…</span>
      </div>
      <div id="readerContent" class="reader-content" style="display:none;"></div>
      <div id="epubContainer" class="epub-container"></div>
    </div>
  </div>
</section>


<!-- Statistik section removed -->

<!-- Kategori section removed -->

<!-- Fitur Unggulan section removed -->

<!-- Testimoni (second) section removed -->

<!-- FAQ section removed -->

<!-- Kontak section removed -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://unpkg.com/aos@next/dist/aos.js"></script>
  <!-- EPUB.js for in-site EPUB reader -->
  <script src="https://cdn.jsdelivr.net/npm/epubjs@0.3/dist/epub.min.js"></script>
  <script>
    AOS.init();
  </script>
  <script>
    // Gutendex API helper
    const API_BASE = 'https://gutendex.com/books/';

    const el = (id) => document.getElementById(id);
    const resultsEl = el('results');
    const statusEl = el('libraryStatus');

    // Ensure modals are hidden on initial load
    document.addEventListener('DOMContentLoaded', () => {
      const ids = ['readerModal','readerBackdrop','infoModal','infoBackdrop'];
      ids.forEach(id => {
        const node = document.getElementById(id);
        if (node) node.style.display = 'none';
      });
      document.body.style.overflow = '';
    });

    function setStatus(type, html) {
      const mapping = {
        loading: `<div class="d-flex justify-content-center align-items-center gap-2 text-muted"><span class="spinner"></span><span>Memuat…</span></div>`,
        empty: `<div class="library-empty">${html}</div>`,
        error: `<div class="library-error">${html}</div>`,
        info: `<div class="text-muted">${html}</div>`
      };
      statusEl.innerHTML = mapping[type] || html;
    }

    function authorNames(authors) {
      if (!authors || !authors.length) return 'Tidak diketahui';
      return authors.map(a => a.name).join(', ');
    }

    // Detail/info modal controller (top-level scope)
    const info = {
      modal: document.getElementById('infoModal'),
      backdrop: document.getElementById('infoBackdrop'),
      title: document.getElementById('infoTitle'),
      body: document.getElementById('infoBody'),
      open(title) {
        this.title.textContent = title || 'Detail Buku';
        this.modal.style.display = 'block';
        this.backdrop.style.display = 'block';
      },
      close() {
        this.modal.style.display = 'none';
        this.backdrop.style.display = 'none';
      },
      set(html) {
        this.body.innerHTML = html;
      }
    };

    function pickFormat(formats) {
  // Prefer for DOWNLOAD: epub, pdf, then text/plain, then html
  const keys = Object.keys(formats || {});
  const byPref = [
    'application/epub+zip',
    'application/pdf',
    'text/plain; charset=utf-8',
    'text/plain; charset=us-ascii',
    'text/plain',
    'text/html; charset=utf-8',
    'text/html'
  ];
  for (const pref of byPref) {
    const key = keys.find(k => k.toLowerCase() === pref.toLowerCase());
    if (key && formats[key]) return { mime: pref, url: formats[key] };
  }
  // fallback to any
  for (const k of keys) if (formats[k]) return { mime: k, url: formats[k] };
  return null;
}

    function coverUrl(formats) {
  return formats?.['image/jpeg'] || 'https://placehold.co/400x600?text=No+Cover';
}

// CORS text proxy (read-only) fallback
function proxied(url) {
  try {
    return 'https://r.jina.ai/http://' + url.replace(/^https?:\/\//, '');
  } catch(_) {
    return url;
  }
}

    function openExternal(url) {
      window.open(url, '_blank', 'noopener');
    }

    async function doSearch(q) {
      resultsEl.innerHTML = '';
      if (!q || !q.trim()) {
        setStatus('info', 'Masukkan kata kunci untuk mulai mencari.');
        return;
      }
      setStatus('loading');
      try {
        const res = await fetch(`${API_BASE}?search=${encodeURIComponent(q.trim())}`);
        if (!res.ok) throw new Error('Gagal memuat');
        const data = await res.json();
        if (!data.results || !data.results.length) {
          setStatus('empty', 'Tidak ada hasil. Coba kata kunci lain.');
          return;
        }
        setStatus('');
        renderResults(data.results);
      } catch (e) {
        setStatus('error', 'Terjadi kesalahan saat memuat data. Coba lagi.');
        console.error(e);
      }
    }

    function renderResults(items) {
  const frag = document.createDocumentFragment();
  items.forEach(book => {
    const fmt = pickFormat(book.formats);
    const col = document.createElement('div');
    col.className = 'col-12 col-sm-6 col-md-4 col-lg-3 d-flex';
    col.innerHTML = `
      <div class="card h-100 w-100">
        <img class="card-img-top" src="${coverUrl(book.formats)}" alt="${book.title}">
        <div class="card-body d-flex flex-column">
          <h6 class="fw-bold mb-1" title="${book.title}">${book.title}</h6>
          <div class="text-muted small mb-2">${authorNames(book.authors)}</div>
          <div class="mt-auto d-grid gap-2">
            <button class="btn btn-primary btn-sm" data-action="read" data-id="${book.id}">Baca</button>
            <button class="btn btn-outline-secondary btn-sm" data-action="detail" data-id="${book.id}">Detail</button>
            ${fmt ? `<a class="btn btn-outline-primary btn-sm" href="${fmt.url}" data-action="download" data-mime="${fmt.mime}" data-title="${book.title.replace(/"/g, '')}">Unduh</a>` : ''}
          </div>
        </div>
      </div>`;
    frag.appendChild(col);
  });
  resultsEl.innerHTML = '';
  resultsEl.appendChild(frag);
}

    // Simple in-site reader using text/plain when available
    let epubBook = null;
    let epubRendition = null;

    const reader = {
      modal: document.getElementById('readerModal'),
      backdrop: document.getElementById('readerBackdrop'),
      title: document.getElementById('readerTitle'),
      loading: document.getElementById('readerLoading'),
      content: document.getElementById('readerContent'),
      epubEl: document.getElementById('epubContainer'),
      dark: false,
      fontSize: 16,
      originalText: '',
      isTranslated: false,
      
      open(title) {
        this.title.textContent = title || 'Membaca…';
        this.showLoading();
        this.modal.style.display = 'flex';
        this.backdrop.style.display = 'block';
        document.body.style.overflow = 'hidden';
      },
      
      showLoading() {
        this.loading.style.display = 'flex';
        this.content.style.display = 'none';
        this.epubEl.style.display = 'none';
      },
      
      showText(text) {
        if (!text || text.trim().length === 0) {
          this.showError('Konten kosong atau tidak dapat dimuat.');
          return;
        }
        this.loading.style.display = 'none';
        this.epubEl.style.display = 'none';
        this.content.style.display = 'block';
        this.content.textContent = text;
        this.content.style.fontSize = this.fontSize + 'px';
        this.originalText = text;
        this.isTranslated = false;
        this.translatedCache = new Map(); // Cache for translated chunks
        this.currentScrollPos = 0;
      },
      
      showError(message) {
        this.loading.style.display = 'none';
        this.epubEl.style.display = 'none';
        this.content.style.display = 'block';
        this.content.innerHTML = `<div style="text-align: center; color: #ef4444; padding: 40px;"><i class="bi bi-exclamation-triangle" style="font-size: 2rem; margin-bottom: 16px;"></i><br>${message}</div>`;
      },
      
      async showEpub(url) {
        try {
          // cleanup existing
          if (epubRendition) { await epubRendition.destroy(); }
          epubRendition = null; epubBook = null;
          
          this.loading.style.display = 'none';
          this.content.style.display = 'none';
          this.epubEl.style.display = 'block';
          this.epubEl.innerHTML = ''; // clear container
          
          epubBook = ePub(url);
          epubRendition = epubBook.renderTo(this.epubEl, { 
            width: '100%', 
            height: '100%',
            flow: 'paginated',
            manager: 'default'
          });
          await epubRendition.display();
        } catch (e) {
          console.error('EPUB render error:', e);
          this.showError('Gagal menampilkan EPUB. Membuka di tab baru…');
          setTimeout(() => window.open(url, '_blank', 'noopener'), 2000);
        }
      },
      
      close() {
        try { if (epubRendition) epubRendition.destroy(); } catch(_){}
        epubRendition = null; epubBook = null;
        this.modal.style.display = 'none';
        this.backdrop.style.display = 'none';
        document.body.style.overflow = '';
      },
      
      setFont(delta) {
        this.fontSize = Math.min(28, Math.max(12, this.fontSize + delta));
        this.content.style.fontSize = this.fontSize + 'px';
      },
      
      toggleTheme() {
        this.dark = !this.dark;
        if (this.dark) {
          this.modal.classList.add('reader-dark');
        } else {
          this.modal.classList.remove('reader-dark');
        }
      }
    };

    // CORS-friendly translation using multiple approaches
    async function translateViaProxy(text) {
      // Try CORS proxy with LibreTranslate
      try {
        const proxyUrl = 'https://api.allorigins.win/raw?url=';
        const targetUrl = encodeURIComponent('https://libretranslate.com/translate');
        const params = new URLSearchParams();
        params.set('q', text);
        params.set('source', 'auto');
        params.set('target', 'id');
        params.set('format', 'text');
        
        const res = await fetch(proxyUrl + targetUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: params
        });
        
        if (res.ok) {
          const data = await res.json();
          if (data && data.translatedText) return data.translatedText;
        }
      } catch (e) {
        console.warn('Proxy translation failed:', e);
      }
      
      // Fallback to Google Translate API (public endpoint)
      try {
        const googleUrl = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=auto&tl=id&dt=t&q=${encodeURIComponent(text)}`;
        const res = await fetch(googleUrl);
        if (res.ok) {
          const data = await res.json();
          if (data && data[0] && data[0][0] && data[0][0][0]) {
            return data[0].map(item => item[0]).join('');
          }
        }
      } catch (e) {
        console.warn('Google Translate failed:', e);
      }
      
      // Final fallback - simple word replacement for common terms
      return translateBasic(text);
    }

    function translateBasic(text) {
      const basicDict = {
        'the': 'yang', 'and': 'dan', 'of': 'dari', 'to': 'ke', 'in': 'di',
        'a': 'sebuah', 'is': 'adalah', 'it': 'itu', 'you': 'kamu', 'that': 'bahwa',
        'he': 'dia', 'was': 'adalah', 'for': 'untuk', 'on': 'pada', 'are': 'adalah',
        'as': 'sebagai', 'with': 'dengan', 'his': 'nya', 'they': 'mereka', 'at': 'di',
        'be': 'menjadi', 'this': 'ini', 'have': 'memiliki', 'from': 'dari', 'or': 'atau',
        'one': 'satu', 'had': 'memiliki', 'by': 'oleh', 'word': 'kata', 'but': 'tapi',
        'not': 'tidak', 'what': 'apa', 'all': 'semua', 'were': 'adalah', 'we': 'kita',
        'when': 'ketika', 'your': 'kamu', 'can': 'bisa', 'said': 'berkata', 'there': 'ada',
        'each': 'setiap', 'which': 'yang', 'she': 'dia', 'do': 'melakukan', 'how': 'bagaimana',
        'their': 'mereka', 'if': 'jika', 'will': 'akan', 'up': 'naik', 'other': 'lain',
        'about': 'tentang', 'out': 'keluar', 'many': 'banyak', 'then': 'kemudian', 'them': 'mereka',
        'these': 'ini', 'so': 'jadi', 'some': 'beberapa', 'her': 'dia', 'would': 'akan',
        'make': 'membuat', 'like': 'seperti', 'into': 'ke dalam', 'him': 'dia', 'has': 'memiliki',
        'two': 'dua', 'more': 'lebih', 'very': 'sangat', 'after': 'setelah', 'words': 'kata-kata',
        'Chapter': 'Bab', 'chapter': 'bab', 'Book': 'Buku', 'book': 'buku'
      };
      
      let result = text;
      Object.entries(basicDict).forEach(([en, id]) => {
        const regex = new RegExp(`\\b${en}\\b`, 'gi');
        result = result.replace(regex, id);
      });
      
      return `[Terjemahan Dasar] ${result}`;
    }

    // Progressive translation function
    async function translateProgressively(remainingChunks, translatedParts, btn, totalChunks) {
      for (let i = 0; i < remainingChunks.length; i++) {
        try {
          const translated = await translateViaProxy(remainingChunks[i]);
          translatedParts.push(translated || remainingChunks[i]);
          
          // Update display with new translated content
          const progress = Math.round(((translatedParts.length) / totalChunks) * 100);
          reader.content.textContent = translatedParts.join(' ');
          btn.textContent = `Menerjemahkan... (${progress}%)`;
          
          // Small delay to prevent overwhelming the API
          await new Promise(resolve => setTimeout(resolve, 500));
        } catch (e) {
          console.warn('Progressive translation chunk failed:', e);
          translatedParts.push(remainingChunks[i]); // Use original if translation fails
        }
      }
      
      // Translation complete
      btn.textContent = 'Tampilkan Asli';
      btn.disabled = false;
    }

    async function translateCurrent() {
      try {
        const btn = document.getElementById('translateToggle');
        // Disable when EPUB is shown
        if (reader.epubEl.style.display !== 'none' && reader.epubEl.style.display !== '') {
          reader.showError('Terjemahan langsung hanya tersedia untuk teks. EPUB akan dibuka di tab baru atau gunakan format teks.');
          return;
        }
        // Must have content visible
        if (reader.content.style.display === 'none' || !reader.originalText) {
          setStatus('info', 'Tidak ada teks untuk diterjemahkan.');
          return;
        }

        if (!reader.isTranslated) {
          btn.disabled = true; btn.textContent = 'Menerjemahkan…';
          
          const text = reader.originalText;
          const chunkSize = 2000;
          const chunks = [];
          
          // Split text into chunks
          for (let i = 0; i < text.length; i += chunkSize) {
            chunks.push(text.substring(i, i + chunkSize));
          }
          
          try {
            // Translate first chunk immediately for fast response
            const firstTranslated = await translateViaProxy(chunks[0]);
            
            if (firstTranslated && firstTranslated.trim()) {
              // Show first translated chunk + placeholder for rest
              let displayText = firstTranslated;
              if (chunks.length > 1) {
                displayText += '\n\n[Menerjemahkan bagian selanjutnya...]\n\n' + chunks.slice(1).join('');
              }
              reader.content.textContent = displayText;
              reader.isTranslated = true;
              btn.textContent = 'Menerjemahkan... (' + Math.round((1/chunks.length)*100) + '%)';
              
              // Continue translating remaining chunks in background
              translateProgressively(chunks.slice(1), [firstTranslated], btn, chunks.length);
            } else {
              setStatus('error', 'Gagal memperoleh hasil terjemahan.');
              btn.textContent = 'Terjemahkan (ID)';
              btn.disabled = false;
            }
          } catch (e) {
            console.error('Translation error:', e);
            setStatus('error', 'Terjadi kesalahan saat menerjemahkan.');
            btn.textContent = 'Terjemahkan (ID)';
            btn.disabled = false;
          }
        } else {
          // revert to original
          reader.content.textContent = reader.originalText;
          reader.isTranslated = false;
          document.getElementById('translateToggle').textContent = 'Terjemahkan (ID)';
        }
      } catch (e) {
        console.error('translate error:', e);
        setStatus('error', 'Terjadi kesalahan saat menerjemahkan. Coba lagi.');
        const btn = document.getElementById('translateToggle');
        btn.disabled = false; btn.textContent = 'Terjemahkan (ID)';
      }
    }

    async function readBook(id, title) {
      try {
        setStatus('', '');
        reader.open(title);
        
        const res = await fetch(`${API_BASE}${id}`);
        if (!res.ok) throw new Error('Gagal memuat detail');
        const book = await res.json();
        const fmts = book.formats || {};
        
        console.log('Book formats:', fmts); // Debug log
        
        const textUrl = fmts['text/plain; charset=utf-8'] || fmts['text/plain; charset=us-ascii'] || fmts['text/plain'];
        const htmlUrl = fmts['text/html; charset=utf-8'] || fmts['text/html'];
        const epubUrl = fmts['application/epub+zip'];
        
        // Try text first
        if (textUrl) {
          console.log('Trying text URL:', textUrl);
          try {
            const tx = await fetch(textUrl, { mode: 'cors' });
            if (tx.ok) {
              const text = await tx.text();
              console.log('Text length:', text.length);
              if (text && text.trim().length > 10) {
                reader.showText(text);
                return;
              }
            }
          } catch (e) {
            console.warn('Direct text fetch failed:', e);
          }
          
          // Try proxy fallback
          try {
            console.log('Trying proxy:', proxied(textUrl));
            const ptx = await fetch(proxied(textUrl));
            if (ptx.ok) {
              const ptext = await ptx.text();
              console.log('Proxy text length:', ptext.length);
              if (ptext && ptext.trim().length > 10) {
                reader.showText(ptext);
                return;
              }
            }
          } catch (e) {
            console.warn('Proxy text fetch failed:', e);
          }
        }
        
        // Try EPUB
        if (epubUrl) {
          console.log('Trying EPUB:', epubUrl);
          await reader.showEpub(epubUrl);
          return;
        }
        
        // Try HTML in new tab
        if (htmlUrl) {
          console.log('Opening HTML in new tab:', htmlUrl);
          reader.close();
          openExternal(htmlUrl);
          return;
        }
        
        // Try PDF in new tab
        if (fmts['application/pdf']) {
          console.log('Opening PDF in new tab:', fmts['application/pdf']);
          reader.close();
          openExternal(fmts['application/pdf']);
          return;
        }
        
        reader.showError('Format tidak tersedia untuk dibaca langsung.');
        
      } catch (e) {
        console.error('readBook error:', e);
        reader.showError('Gagal memuat konten. Coba lagi.');
      }
    }

    // Event wiring
    el('searchBtn').addEventListener('click', () => doSearch(el('searchInput').value));
    el('clearBtn').addEventListener('click', () => {
      el('searchInput').value = '';
      resultsEl.innerHTML = '';
      setStatus('', '');
    });
    el('searchInput').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') doSearch(el('searchInput').value);
    });
    resultsEl.addEventListener('click', (e) => {
      const readBtn = e.target.closest('[data-action="read"]');
      if (readBtn) {
        const id = readBtn.getAttribute('data-id');
        const title = readBtn.closest('.card').querySelector('h6')?.textContent || 'Buku';
        readBook(id, title);
        return;
      }
      const detailBtn = e.target.closest('[data-action="detail"]');
      if (detailBtn) {
        const id = detailBtn.getAttribute('data-id');
        const title = detailBtn.closest('.card').querySelector('h6')?.textContent || 'Detail Buku';
        info.open(title);
        info.set(`<div class="d-flex justify-content-center align-items-center gap-2 text-muted"><span class=\"spinner\"></span><span>Memuat detail…</span></div>`);
        fetch(`${API_BASE}${id}`).then(r => r.json()).then(book => {
          const fmts = book.formats || {};
          const cover = coverUrl(fmts);
          const authors = authorNames(book.authors);
          const subjects = (book.subjects || []).slice(0, 10).join(', ');
          const languages = (book.languages || []).join(', ');
          const download = pickFormat(fmts);
          const html = `
            <div class="row g-3">
              <div class="col-12 col-md-4 text-center">
                <img src="${cover}" alt="${book.title}" class="img-fluid rounded shadow-sm" />
              </div>
              <div class="col-12 col-md-8">
                <h5 class="mb-1">${book.title}</h5>
                <div class="text-muted mb-2">${authors}</div>
                <div class="small mb-2"><strong>Bahasa:</strong> ${languages || 'Tidak diketahui'}</div>
                <div class="small mb-2"><strong>Subjek:</strong> ${subjects || '—'}</div>
                <div class="small mb-3"><strong>Unduhan:</strong> ${book.download_count ?? '—'}</div>
                <div class="d-flex flex-wrap gap-2">
                  <button class="btn btn-primary btn-sm" data-action="read" data-id="${book.id}">Baca</button>
                  <a class="btn btn-outline-secondary btn-sm" href="https://www.gutenberg.org/ebooks/${book.id}" target="_blank" rel="noopener">Halaman Gutenberg</a>
                  ${download ? `<a class="btn btn-outline-primary btn-sm" href="${download.url}" data-action="download" data-mime="${download.mime}" data-title="${book.title.replace(/"/g, '')}">Unduh</a>` : ''}
                </div>
              </div>
            </div>`;
          info.set(html);
        }).catch(() => {
          info.set('<div class="library-error">Gagal memuat detail.</div>');
        });
        return;
      }
      const dl = e.target.closest('[data-action="download"]');
      if (dl) {
        e.preventDefault();
        const url = dl.getAttribute('href');
        const mime = dl.getAttribute('data-mime') || 'application/octet-stream';
        const baseTitle = dl.getAttribute('data-title') || 'ebook';
        let ext = 'bin';
        if (mime.includes('epub')) ext = 'epub';
        else if (mime.includes('pdf')) ext = 'pdf';
        else if (mime.includes('html')) ext = 'html';
        else if (mime.includes('text')) ext = 'txt';
        const filename = `${baseTitle}.${ext}`.replace(/\s+/g, '_');
        // Try CORS download; fallback to opening in new tab
        fetch(url, { mode: 'cors' }).then(r => {
          if (!r.ok) throw new Error('HTTP '+r.status);
          return r.blob();
        }).then(blob => {
          const a = document.createElement('a');
          const objectUrl = URL.createObjectURL(blob);
          a.href = objectUrl;
          a.download = filename;
          document.body.appendChild(a);
          a.click();
          a.remove();
          setTimeout(() => URL.revokeObjectURL(objectUrl), 2000);
        }).catch(() => {
          // Fallback: open in new tab
          window.open(url, '_blank', 'noopener');
        });
      }
    });
    el('closeReader').addEventListener('click', () => reader.close());
    el('readerBackdrop').addEventListener('click', () => reader.close());
    el('closeInfo').addEventListener('click', () => info.close());
    el('infoBackdrop').addEventListener('click', () => info.close());
    el('fontPlus').addEventListener('click', () => reader.setFont(2));
    el('fontMinus').addEventListener('click', () => reader.setFont(-2));
    el('toggleTheme').addEventListener('click', () => reader.toggleTheme());
    el('translateToggle').addEventListener('click', translateCurrent);
  </script>

</body>
</html>
